name: Deploy to IONOS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to IONOS Server
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.IONOS_HOST }}
          username: ${{ secrets.IONOS_USERNAME }}
          password: ${{ secrets.IONOS_PASSWORD }}
          port: 22
          script: |
            echo "========================================"
            echo "Starting deployment at $(date)"
            echo "========================================"
            
            # Navigate to hosting directory
            cd /kunden/homepages/39/d4299589649/htdocs/
            
            # Clone or pull repository
            if [ -d "RPP_AUTO" ]; then
              echo "Repository exists, pulling latest changes..."
              cd RPP_AUTO
              git pull origin main
            else
              echo "Cloning repository..."
              git clone https://github.com/Owwmann/RPP-AUTO-FullStack.git RPP_AUTO
              cd RPP_AUTO
            fi
            
            echo "Current directory: $(pwd)"
            
            # Setup Python virtual environment
            echo "Setting up Python virtual environment..."
            python3 -m venv venv
            source venv/bin/activate
            
            # Install dependencies
            echo "Installing dependencies..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # Create production environment file
            echo "Creating production.env file..."
            cat > production.env << EOF
            ENVIRONMENT=production
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            EOF
            
            # Kill existing uvicorn processes
            echo "Stopping existing application processes..."
            pkill -f uvicorn || echo "No existing uvicorn process found"
            
            # Wait for process to terminate
            sleep 2
            
            # Start application
            echo "Starting application..."
            nohup venv/bin/uvicorn main:app --host 0.0.0.0 --port 8080 --workers 2 > ../rpp_log.txt 2>&1 &
            
            # Wait a moment and check if process started
            sleep 3
            if pgrep -f "uvicorn main:app" > /dev/null; then
              echo "✅ Application started successfully!"
            else
              echo "❌ Application failed to start. Check logs at /kunden/homepages/39/d4299589649/htdocs/rpp_log.txt"
              exit 1
            fi
            
            # Create/Update .htaccess for routing
            echo "Configuring .htaccess..."
            cd /kunden/homepages/39/d4299589649/htdocs/
            cat > .htaccess << 'HTACCESS_EOF'
            # RPP AUTO Application Routing
            RewriteEngine On
            
            # Proxy all requests to the FastAPI application on port 8080
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ http://localhost:8080/$1 [P,L]
            
            # Enable proxy pass through
            ProxyPreserveHost On
            HTACCESS_EOF
            
            echo "========================================"
            echo "Deployment completed at $(date)"
            echo "Application should be accessible at your domain"
            echo "Logs available at: /kunden/homepages/39/d4299589649/htdocs/rpp_log.txt"
            echo "========================================"
